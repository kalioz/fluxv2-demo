# Première synchro avec Git

Nous avons maintenant un repo git lié avec notre cluster; Ajoutons un objet dedans pour le voir déployé dans le cluster !

Nous allons commencer avec un objet simple, un déploiement d'un serveur "hello-world".

Nous allons créer le fichier `environments/minikube/dev/applications/hello-world/hello-world-deployment.yaml` et ajouter ce déploiement dedans :

```yaml
# cat environments/minikube/dev/applications/hello-world/hello-world-deployment.yaml
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-world
  namespace: default
  labels:
    app: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.7.9
        ports:
        - containerPort: 80
```

Une fois que vous avez sauvegardé le fichier, commitez le et poussez le dans la branche `main` de votre repo github :

```bash
git checkout main
git add environments/minikube/dev/applications/hello-world/hello-world-deployment.yaml
git commit -m "[minikube/dev] feat: add hello-world deployment"
git push
```

> Pour le reste du tutoriel, lorsque nous parlons d'ajouter un fichier, cela veut dire l'ajouter à git en le poussant sur la branche main de github.

Après un certain temps (10 minutes pour la boucle de réconciliation par défaut), vous devriez voir votre application apparaitre dans le cluster :

```bash
$ kubectl get pods -n default
NAME                                READY   STATUS    RESTARTS   AGE
hello-world-5d59d67564-9bpsw   1/1     Running   0          21m
```

Observez la structure du `deployment` qui a été créé (`kubectl get deploy hello-world -n default -o yaml`):
- deux labels `kustomize.toolkit.fluxcd.io/[name,namespace]` existent
- l'annotation présente lors des déploiements manuels est absente.

Essayez d'éditer manuellement le déploiement, par example en augmentant le nombre de réplicas :

```bash
kubectl scale deployment --replicas 5 hello-world
```

Le déploiement va avoir 5 répliques jusqu'à la prochaine réconciliation, où flux va voir qu'il y a eu un changement et rétablir ce qui existe dans git.

Si vous voulez que vos changements manuels ne soient pas supprimés par flux temporairement, vous pouvez utiliser la CLI pour pauser la réconciliation sur la ressource :

```bash
kubectl annotate deploy/nginx-deployment kustomize.toolkit.fluxcd.io/reconcile=disabled
```

Pour réactiver la réconciliation, vous devrez supprimer l'annotation :
```bash
kubectl annotate deploy/nginx-deployment kustomize.toolkit.fluxcd.io/reconcile-
```

## Ajoutons plus de ressources

Ajoutons plus de ressources utiles au tuto :

```yaml
# cat environments/minikube/dev/namespaces/namespaces.yaml

---
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
---
apiVersion: v1
kind: Namespace
metadata:
  name: sealed-secrets
---
apiVersion: v1
kind: Namespace
metadata:
  name: kyverno
```

> Idéalement, vous devriez viser un fichier par manifeste, et les namespaces devraient être mis avec les applications qu'ils hébergent; nous faisons cela ainsi afin de gagner du temps.

## Réduire la boucle de réconciliation

La boucle de réconciliation configurée par défaut est de 10m. Pour accélerer les choses, changez la à 1m dans le fichier `environments/minikube/dev/flux-system/gotk-sync.yaml`.

Les valeurs que je recommenderais serait 12h pour les clusters de dev (pour permettre les tests manuels) et 10m pour les clusters de prod.

```diff
# $ cat environments/minikube/dev/flux-system/gotk-sync.yaml
# This manifest was generated by flux. DO NOT EDIT.
---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: GitRepository
metadata:
  name: flux-system
  namespace: flux-system
spec:
  interval: 1m0s
  ref:
    branch: main
  secretRef:
    name: flux-system
  url: ssh://git@github.com/kalioz/fluxv2-demo
---
apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: flux-system
  namespace: flux-system
spec:
-  interval: 10m0s
+  interval: 1m0s
  path: ./environments/minikube/dev
  prune: true
  sourceRef:
    kind: GitRepository
    name: flux-system
```
