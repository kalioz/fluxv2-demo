# First sync using git

We now have a git repository linked with our cluster. Let's add an object in git to see it deployed in our cluster !

We'll start with an easy object, a Deployment of a "hello-word" nginx server.

We'll create the file `environments/minikube/dev/applications/hello-world/hello-world-deployment.yaml` and add a deployment in it.

```yaml
# cat environments/minikube/dev/applications/hello-world/hello-world-deployment.yaml
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-world
  namespace: default
  labels:
    app: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.7.9
        ports:
        - containerPort: 80
```

Once you have saved your file, commit it and push it in the `main` branch of your github repository :

```bash
git checkout main
git add environments/minikube/dev/applications/hello-world/hello-world-deployment.yaml
git commit -m "[minikube/dev] feat: add hello-world deployment"
git push
```

After some time (10 minutes for the default reconciliation loop), you should see the application appear in your cluster :
```bash
$ kubectl get pods -n default
NAME                                READY   STATUS    RESTARTS   AGE
hello-world-5d59d67564-9bpsw   1/1     Running   0          21m
```

You should now see the application appear in the default namespace :)

Take a look at the structure of the `deployment` object that has been created (`kubectl get deploy hello-world -n default -o yaml`):
- two labels `kustomize.toolkit.fluxcd.io/[name,namespace]` exists
- the annotation used by kubectl for manual deployments isn't present

Now, try to edit manually the deployment, for example to increase the number of replicas present :
```bash
kubectl scale deployment --replicas 5 hello-world
```
The deployment will be scaled up until the next reconciliation, which should happen under 10m for a default installation.

If you want your manual edits to stay, you'll need to use the cli to edit the ressource and pause it by adding an annotation:

```bash
kubectl annotate deploy/hello-world kustomize.toolkit.fluxcd.io/reconcile=disabled
```

To resume the reconciliation on the ressource, you need to remove the annotation :
```bash
kubectl annotate deploy/hello-world kustomize.toolkit.fluxcd.io/reconcile-
```

## Adding some more ressources

Let's add some ressources that will be useful for this tutorial :

```yaml
# cat environments/minikube/dev/namespaces/namespaces.yaml

---
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
---
apiVersion: v1
kind: Namespace
metadata:
  name: sealed-secrets
---
apiVersion: v1
kind: Namespace
metadata:
  name: kyverno
```

> ideally you should try to aim to have one file per manifest, so you can read your git without getting into the files.


> You can witness the entities under the responsability of a Kustomization by running `flux tree kustomization \[kustomization_name\]`

## Reduce the reconciliation loop duration

The default reconciliation loop configured in Kustomize is set to 10m. To speed things up, change it to 1m in the file `environments/minikube/dev/flux-system/gotk-sync.yaml`, commit it and push it to the main branch.

The values i'd recommend for the reconciliation interval in your clusters are 12h for dev envs (to allow manual changes without them being removed by flux), and 10m for production.

```diff
# $ cat environments/minikube/dev/flux-system/gotk-sync.yaml
# This manifest was generated by flux. DO NOT EDIT.
---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: GitRepository
metadata:
  name: flux-system
  namespace: flux-system
spec:
  interval: 1m0s
  ref:
    branch: main
  secretRef:
    name: flux-system
  url: ssh://git@github.com/kalioz/fluxv2-demo
---
apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: flux-system
  namespace: flux-system
spec:
-  interval: 10m0s
+  interval: 1m0s
  path: ./environments/minikube/dev
  prune: true
  sourceRef:
    kind: GitRepository
    name: flux-system
```

## Force flux entities reconciliation

Flux CLI allows you to force reconciliation.   
For instance you can launch:  
```bash
flux reconcile source git flux-system && flux reconcile kustomization flux-system
```

Go to [step 3](./03.using-helmreleases.md)
